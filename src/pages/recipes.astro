---
import SiteLayout from "../layouts/SiteLayout.astro";
import NavBar from "../components/NavBar.astro";
import Footer from "../components/Footer.astro";
import "../styles/mods.css";
import "../styles/recipes.css";

import alpineWhispers from "./wiki/config/alpine-whispers.js";
import bakery from "./wiki/config/bakery.js";
import beachparty from "./wiki/config/beachparty.js";
import bloomingnature from "./wiki/config/bloomingnature.js";
import brewery from "./wiki/config/brewery.js";
import camping from "./wiki/config/camping.js";
import candlelight from "./wiki/config/candlelight.js";
import farmAndCharm from "./wiki/config/farm-and-charm.js";
import furniture from "./wiki/config/furniture.js";
import hearthAndTimber from "./wiki/config/hearth-and-timber.js";
import herbalbrews from "./wiki/config/herbalbrews.js";
import lilisLuckyLures from "./wiki/config/lilis-lucky-lures.js";
import lilisPottery from "./wiki/config/lilis-pottery.js";
import meadow from "./wiki/config/meadow.js";
import vinery from "./wiki/config/vinery.js";
import wildernature from "./wiki/config/wildernature.js";

import {
  buildStationRegistry,
  flattenWikiEntries,
  mergeWikiEntries,
  normalizeRecipes,
  normalizeId
} from "./recipes/recipe_grids.js";

const toTitle = (identifier) => {
  const raw = String(identifier ?? "");
  const path = raw.includes(":") ? raw.split(":")[1] : raw;
  return String(path ?? "")
    .split("_")
    .filter(Boolean)
    .map((word) => word.slice(0, 1).toUpperCase() + word.slice(1))
    .join(" ");
};

const allWikiConfigs = [
  alpineWhispers,
  bakery,
  beachparty,
  bloomingnature,
  brewery,
  camping,
  candlelight,
  farmAndCharm,
  furniture,
  hearthAndTimber,
  herbalbrews,
  lilisLuckyLures,
  lilisPottery,
  meadow,
  vinery,
  wildernature
];

const wikiIndexes = allWikiConfigs.map((config) => flattenWikiEntries(config));
const wikiEntries = mergeWikiEntries(wikiIndexes);

const stationRegistry = buildStationRegistry({ wikiEntries });

const recipeModules = import.meta.glob("../recipes/**/*.json", { eager: true });

const loadedRecipes = Object.entries(recipeModules)
  .flatMap(([sourcePath, moduleValue]) => {
    const value = moduleValue?.default ?? moduleValue;
    if (!value) return [];

    if (Array.isArray(value)) {
      return value
        .filter(Boolean)
        .map((recipe) => (recipe && typeof recipe === "object" ? { ...recipe, __sourcePath: sourcePath } : recipe))
        .filter(Boolean);
    }

    if (value && typeof value === "object") {
      return [{ ...value, __sourcePath: sourcePath }];
    }

    return [];
  })
  .filter(Boolean);

const normalizedRecipes = normalizeRecipes({
  recipes: loadedRecipes,
  stationRegistry,
  wikiEntries,
  toTitle
});

const groupedStations = Object.values(
  normalizedRecipes.reduce((accumulator, recipe) => {
    const key = recipe.station.key;
    if (!accumulator[key]) {
      accumulator[key] = {
        key,
        title: recipe.station.title,
        subtitleHtml: recipe.station.subtitleHtml || "",
        icon: recipe.station.icon,
        wiki: recipe.station.wiki,
        recipes: [],
        search: recipe.station.search
      };
    }
    accumulator[key].recipes.push(recipe);
    return accumulator;
  }, {})
);
---

<SiteLayout title="Recipes">
  <Fragment slot="head">
    <link rel="preload" as="image" href="/assets/icons/hero_mods.webp" />
  </Fragment>

  <NavBar />

  <main class="page">
    <section class="section sectionCentered">
      <div class="aboutHero modsHero">
        <div class="aboutHeroBackground modsHeroBackground"></div>
        <h1>Recipes</h1>
      </div>
    </section>

    <section class="section sectionCentered sectionTight">
      <div class="recipesInfo">
        <div class="sectionTitle">
          <span>Inside our Crafting Stations</span>
        </div>

        <div class="recipesInfoText">
          {`This page contains all custom crafting recipes added by the Let’s Do mods.

You will find every recipe for our unique crafting stations in one place. Regular crafting table recipes are not listed here, since they are already available in the vanilla recipe book inside the game.

This overview is meant for anyone who wants to quickly check ingredients, outputs, or required containers outside of Minecraft, without browsing source code or relying on external tools.
`}
        </div>
      </div>
    </section>

    <section class="section sectionCentered sectionTight">
      <div class="sectionTitle">
        <span>Browse Recipes</span>
      </div>

      <p class="sectionSubtitle">Search by output, ingredient, or station.</p>

      <div class="modsSearch">
        <input
          id="recipesSearchInput"
          class="modsSearchInput"
          type="search"
          placeholder="Search recipes..."
          autocomplete="off"
          spellcheck="false"
        />
        <div id="recipesSearchMeta" class="modsSearchMeta"></div>
      </div>

      <div class="recipesSections">
        {groupedStations.map((group) => (
          <section
            class="recipesSection"
            data-section
            data-station={group.key}
            data-search={group.search}
            data-collapsed="true"
          >
            <button class="recipesSectionHeader" type="button" data-section-toggle aria-expanded="false">
              <a class="recipesStationLink" href={group.wiki} aria-label={group.title} title={group.title} data-station-link>
                <img class="recipesStationIcon" src={group.icon} alt={group.title} loading="lazy" />
              </a>

              <div class="recipesSectionHeaderText">
                <h2 class="recipesSectionTitle">{group.title}</h2>
                {group.subtitleHtml ? <div class="recipesSectionSubtitle" set:html={group.subtitleHtml} /> : null}
              </div>

              <span class="recipesSectionCount">{group.recipes.length}</span>

              <span class="recipesSectionChevron" aria-hidden="true">▾</span>
            </button>

            <div class="recipesGrid" data-grid>
              {group.recipes.map((recipe, recipeIndex) => {
                const recipeCardId = normalizeId(`${group.key}_${recipe.outputTitle ?? "recipe"}_${recipeIndex}`);

                return (
                  <article
                    class="recipeCard"
                    id={recipeCardId}
                    data-card
                    data-card-link="true"
                    data-search={recipe.search}
                    tabindex="0"
                    role="link"
                    aria-label={recipe.outputTitle ?? "Open"}
                    style="position:relative;"
                  >
                    {recipe.stationIcon ? (
                      <span class="recipeStationIconBadge" data-tip-title={recipe.stationRequirementTitle}>
                  <img
                    class="recipeStationIconBadgeIcon"
                    src={recipe.stationIcon}
                    alt={recipe.stationIconAlt}
                  />
                      </span>
                    ) : null}

                    <div class="recipeHeader">
                      <h3 class="recipeTitle">{recipe.outputTitle}</h3>
                      <div class="recipeSubtitle">{recipe.outputSubtitle}</div>
                    </div>

                    <div class="recipeBody">
                      <div class={`recipeLayout ${recipe.station.layout}`}>
                        <div class="recipeInputs" aria-label="Ingredients">
                          {recipe.inputs.map((slot) =>
                            slot && slot.icon ? (
                              slot.href ? (
                                <a
                                  class={`recipeSlot recipeSlotHasItem ${slot.isTag ? "recipeSlotTag" : ""}`}
                                  href={slot.href}
                                  aria-label={slot.title}
                                  data-tip-title={slot.tooltipLine1}
                                  data-tip-sub={slot.tooltipLine2}
                                >
                                  <img class="recipeSlotIcon" src={slot.icon} alt={slot.title} loading="lazy" />
                                </a>
                              ) : (
                                <div
                                  class={`recipeSlot recipeSlotHasItem ${slot.isTag ? "recipeSlotTag" : ""}`}
                                  aria-label={slot.title}
                                  data-tip-title={slot.tooltipLine1}
                                  data-tip-sub={slot.tooltipLine2}
                                >
                                  <img class="recipeSlotIcon" src={slot.icon} alt={slot.title} loading="lazy" />
                                </div>
                              )
                            ) : (
                              <div class="recipeSlot" aria-hidden="true"></div>
                            )
                          )}

                          {recipe.station.showContainerSlot ? (
                            recipe.container && recipe.container.icon ? (
                              recipe.container.href ? (
                                <a
                                  class="recipeSlot recipeSlotContainer recipeSlotHasItem"
                                  href={recipe.container.href}
                                  aria-label={recipe.container.title}
                                  data-tip-title={recipe.container.tooltipLine1}
                                  data-tip-sub={recipe.container.tooltipLine2}
                                >
                                  <img class="recipeSlotIcon" src={recipe.container.icon} alt={recipe.container.title} loading="lazy" />
                                </a>
                              ) : (
                                <div
                                  class="recipeSlot recipeSlotContainer recipeSlotHasItem"
                                  aria-label={recipe.container.title}
                                  data-tip-title={recipe.container.tooltipLine1}
                                  data-tip-sub={recipe.container.tooltipLine2}
                                >
                                  <img class="recipeSlotIcon" src={recipe.container.icon} alt={recipe.container.title} loading="lazy" />
                                </div>
                              )
                            ) : (
                              <div class="recipeSlot recipeSlotContainer" aria-hidden="true"></div>
                            )
                          ) : null}
                        </div>

                        <div class="recipeArrow" aria-hidden="true">→</div>

                        <div class="recipeOutput" aria-label="Output">
                          {recipe.output && recipe.output.icon ? (
                            recipe.output.href ? (
                              <a
                                class="recipeSlot recipeSlotHasItem"
                                href={recipe.output.href}
                                aria-label={recipe.output.title}
                                data-tip-title={recipe.output.tooltipLine1}
                                data-tip-sub={recipe.output.tooltipLine2}
                              >
                                <img class="recipeSlotIcon" src={recipe.output.icon} alt={recipe.output.title} loading="lazy" />
                              </a>
                            ) : (
                              <div
                                class="recipeSlot recipeSlotHasItem"
                                aria-label={recipe.output.title}
                                data-tip-title={recipe.output.tooltipLine1}
                                data-tip-sub={recipe.output.tooltipLine2}
                              >
                                <img class="recipeSlotIcon" src={recipe.output.icon} alt={recipe.output.title} loading="lazy" />
                              </div>
                            )
                          ) : (
                            <div class="recipeSlot" aria-hidden="true"></div>
                          )}
                        </div>
                      </div>
                    </div>
                  </article>
                );
              })}
            </div>
          </section>
        ))}
      </div>

      <div id="recipesEmpty" class="modsEmpty" style="display: none;">
        No recipes match your search.
      </div>
    </section>
  </main>

  <Footer />

  <script is:inline>
    const input = document.getElementById("recipesSearchInput")
    const meta = document.getElementById("recipesSearchMeta")
    const empty = document.getElementById("recipesEmpty")
    const cards = Array.from(document.querySelectorAll("[data-card][data-search]"))
    const sections = Array.from(document.querySelectorAll("[data-section]"))
    const toggles = Array.from(document.querySelectorAll("[data-section-toggle]"))

    const getHashId = () => {
      const raw = (window.location.hash || "").slice(1)
      return raw ? raw.trim() : ""
    }

    const setHash = (hashId) => {
      const cleanId = String(hashId || "").trim()
      if (!cleanId) {
        history.replaceState(null, "", window.location.pathname + window.location.search)
        return ""
      }
      history.replaceState(null, "", `#${cleanId}`)
      return cleanId
    }

    const isInteractiveTarget = (target) => {
      if (!target) return false
      return Boolean(target.closest("a, button, input, textarea, select, label, summary, details"))
    }

    const setCollapsed = (section, collapsed) => {
      section.dataset.collapsed = collapsed ? "true" : "false"
      const toggle = section.querySelector("[data-section-toggle]")
      if (toggle) toggle.setAttribute("aria-expanded", collapsed ? "false" : "true")
    }

    const scrollToCard = (card) => {
      if (!card) return
      requestAnimationFrame(() => {
        requestAnimationFrame(() => {
          card.scrollIntoView({ behavior: "smooth", block: "center" })
        })
      })
      setTimeout(() => {
        card.scrollIntoView({ behavior: "smooth", block: "center" })
      }, 80)
    }

    const update = () => {
      const q = (input.value || "").trim().toLowerCase()
      let visible = 0

      for (const card of cards) {
        const hay = (card.getAttribute("data-search") || "").toLowerCase()
        const show = q.length === 0 || hay.includes(q)
        card.style.display = show ? "" : "none"
        if (show) visible++
      }

      for (const section of sections) {
        const sectionHay = (section.getAttribute("data-search") || "").toLowerCase()
        const sectionCards = Array.from(section.querySelectorAll("[data-card][data-search]"))
        const anyCardVisible = sectionCards.some((card) => (card.style.display ?? "") !== "none")
        const sectionMatches = q.length === 0 || sectionHay.includes(q)
        section.style.display = anyCardVisible || sectionMatches ? "" : "none"
      }

      meta.textContent = q.length === 0 ? `${cards.length} recipes` : `${visible} of ${cards.length}`
      empty.style.display = visible === 0 ? "" : "none"
    }

    const openCard = (card) => {
      if (!card) return

      const section = card.closest("[data-section]")
      if (section) setCollapsed(section, false)

      scrollToCard(card)
    }

    const openFromHash = () => {
      const hashId = getHashId()
      if (!hashId) return

      const target = document.getElementById(hashId)
      if (!target) return

      const card = target.classList.contains("recipeCard") ? target : target.closest(".recipeCard")
      if (!card) return

      openCard(card)
    }

    const activateCardLink = (card) => {
      if (!card || !card.id) return
      setHash(card.id)
      openCard(card)
    }

    for (const toggle of toggles) {
      toggle.addEventListener("click", (event) => {
        const stationLink = event.target.closest("[data-station-link]")
        if (stationLink) return

        const section = toggle.closest("[data-section]")
        if (!section) return

        const collapsed = section.dataset.collapsed === "true"
        setCollapsed(section, !collapsed)
      })
    }

    document.addEventListener("click", (event) => {
      if (isInteractiveTarget(event.target)) return

      const card = event.target.closest('.recipeCard[data-card-link="true"]')
      if (!card) return

      activateCardLink(card)
    })

    document.addEventListener("keydown", (event) => {
      if (event.key !== "Enter" && event.key !== " ") return
      if (isInteractiveTarget(event.target)) return

      const card = event.target.closest('.recipeCard[data-card-link="true"]')
      if (!card) return

      event.preventDefault()
      activateCardLink(card)
    })

    input.addEventListener("input", update)
    window.addEventListener("hashchange", openFromHash, { passive: true })

    update()
    openFromHash()
  </script>
</SiteLayout>