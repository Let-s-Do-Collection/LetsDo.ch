---
const withBase = (path) => {
  if (!path) return ""
  if (path.startsWith("http://") || path.startsWith("https://")) return path
  const base = import.meta.env.BASE_URL || "/"
  const cleanBase = base.endsWith("/") ? base.slice(0, -1) : base
  const cleanPath = path.startsWith("/") ? path : `/${path}`
  return `${cleanBase}${cleanPath}`
}

const {
  id = "impressions",
  title = "Impressions",
  subtitle = "A quick look at how it feels ingame",
  images = [],
} = Astro.props

const normalized = Array.isArray(images) ? images.filter(Boolean) : []
const items = normalized.map((img, index) => {
  if (typeof img === "string") {
    const src = withBase(img)
    return { src, full: src, caption: "", alt: `Impression ${index + 1}` }
  }
  const src = withBase(img.src ?? "")
  const full = withBase((img.full ?? img.src) ?? "")
  const caption = String(img.caption ?? "")
  const alt = String(img.alt ?? (caption || `Impression ${index + 1}`))
  return { src, full: full || src, caption, alt }
})

const hasImages = items.length > 0
const loop = items.length > 1
const loopItems = loop ? [items[items.length - 1], ...items, items[0]] : items
---

{hasImages ? (
  <section class="impressionsSection" id={id} data-impressions-root>
    <div class="wikiSectionHeader">
      <div class="sectionTitle">
        <span>{title}</span>
      </div>
      {subtitle ? <p class="sectionSubtitle">{subtitle}</p> : null}
    </div>

    <div class="impressionsShell" data-impressions-shell>
      <button class="impressionsArrow" data-prev type="button" aria-label="Previous">
        <span aria-hidden="true">‹</span>
      </button>

      <div class="impressionsViewport" data-viewport>
        <div class="impressionsTrack" data-track>
          {loopItems.map((it, i) => {
            const realIndex = loop ? (i === 0 ? items.length - 1 : i === loopItems.length - 1 ? 0 : i - 1) : i
            const isFirstReal = realIndex === 0
            return (
              <button
                class="impressionsSlide"
                type="button"
                data-open
                data-real-index={String(realIndex)}
                data-slide-index={String(i)}
                aria-label={it.alt || "Open"}
              >
                <div class="impressionsFrame">
                  <img
                    class="impressionsImg"
                    src={it.src}
                    alt={it.alt}
                    loading={isFirstReal ? "eager" : "lazy"}
                    decoding="async"
                    fetchpriority={isFirstReal ? "high" : "auto"}
                  />
                </div>
                <div class="impressionsCaption">{it.caption}</div>
              </button>
            )
          })}
        </div>
      </div>

      <button class="impressionsArrow" data-next type="button" aria-label="Next">
        <span aria-hidden="true">›</span>
      </button>
    </div>

    <div class="impressionsLightbox" data-lightbox aria-hidden="true">
      <button class="impressionsLightboxBackdrop" type="button" aria-label="Close" data-close></button>

      <div class="impressionsLightboxInner" role="dialog" aria-modal="true" aria-label="Impressions">
        <button class="impressionsLightboxBtn impressionsLightboxPrev" type="button" aria-label="Previous" data-lb-prev>
          <span aria-hidden="true">‹</span>
        </button>

        <figure class="impressionsLightboxFigure">
          <img class="impressionsLightboxImg" data-lb-img alt="" loading="eager" decoding="async" />
          <figcaption class="impressionsLightboxCaption" data-lb-cap></figcaption>
        </figure>

        <button class="impressionsLightboxBtn impressionsLightboxNext" type="button" aria-label="Next" data-lb-next>
          <span aria-hidden="true">›</span>
        </button>

        <button class="impressionsLightboxClose" type="button" aria-label="Close" data-close>
          <span aria-hidden="true">×</span>
        </button>
      </div>
    </div>

    <style is:inline>
      .impressionsSection {
        margin-top: 56px;
        margin-bottom: 28px;
      }

      .impressionsShell {
        width: 100%;
        max-width: 1020px;
        margin: 0 auto;
        position: relative;
        display: grid;
        grid-template-columns: 52px 1fr 52px;
        align-items: center;
        gap: 14px;
      }

      .impressionsViewport {
        width: 100%;
        overflow-x: auto;
        overflow-y: hidden;
        scroll-snap-type: x mandatory;
        -webkit-overflow-scrolling: touch;
        overscroll-behavior: contain;
        border-radius: 22px;
        -webkit-mask-image: -webkit-radial-gradient(white, black);
        scrollbar-width: none;
      }

      .impressionsViewport::-webkit-scrollbar {
        display: none;
      }

      .impressionsTrack {
        display: flex;
        width: 100%;
      }

      .impressionsSlide {
        flex: 0 0 100%;
        scroll-snap-align: start;
        scroll-snap-stop: normal;
        appearance: none;
        border: 0;
        padding: 0;
        margin: 0;
        background: transparent;
        cursor: pointer;
        display: grid;
        justify-items: center;
        gap: 10px;
      }

      .impressionsSlide:focus,
      .impressionsSlide:focus-visible {
        outline: none;
      }

      .impressionsFrame {
        width: 100%;
        height: 320px;
        border-radius: 0;
        overflow: hidden;
        transform: translateZ(0);
      }

      .impressionsImg {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        border-radius: 0;
        content-visibility: auto;
        contain-intrinsic-size: 320px 1020px;
      }

      .impressionsCaption {
        text-align: center;
        color: var(--muted);
        font-size: 14px;
        line-height: 1.4;
        min-height: 18px;
      }

      .impressionsArrow {
        appearance: none;
        border: 1px solid var(--border);
        background: var(--card);
        color: var(--text);
        cursor: pointer;
        width: 52px;
        height: 52px;
        border-radius: 999px;
        box-shadow: var(--shadow);
        display: inline-flex;
        align-items: center;
        justify-content: center;
        z-index: 5;
      }

      .impressionsArrow:focus,
      .impressionsArrow:focus-visible {
        outline: none;
      }

      .impressionsArrow span {
        font-size: 34px;
        font-weight: 900;
        line-height: 1;
      }

      .impressionsLightbox {
        position: fixed;
        inset: 0;
        z-index: 999999;
        display: none;
      }

      .impressionsLightbox.isOpen {
        display: block;
      }

      .impressionsLightboxBackdrop {
        position: absolute;
        inset: 0;
        background: rgba(0, 0, 0, 0.62);
        border: 0;
        cursor: pointer;
      }

      .impressionsLightboxInner {
        position: absolute;
        left: 50%;
        top: 50%;
        transform: translate(-50%, -50%);
        width: min(1100px, calc(100vw - 28px));
        max-height: calc(100vh - 28px);
        background: var(--card);
        border: 1px solid var(--borderStrong);
        border-radius: 18px;
        box-shadow: var(--shadowHover);
        display: grid;
        grid-template-columns: 58px 1fr 58px;
        align-items: center;
        padding: 18px;
      }

      .impressionsLightboxFigure {
        margin: 0;
        display: grid;
        grid-template-rows: 1fr auto;
        gap: 10px;
        min-width: 0;
      }

      .impressionsLightboxImg {
        width: 100%;
        height: min(70vh, 720px);
        object-fit: contain;
        border-radius: 14px;
        background: rgba(0, 0, 0, 0.06);
      }

      .impressionsLightboxCaption {
        text-align: center;
        color: var(--muted);
        font-size: 14px;
      }

      .impressionsLightboxBtn {
        appearance: none;
        border: 1px solid var(--border);
        background: rgba(0, 0, 0, 0.03);
        color: var(--text);
        cursor: pointer;
        width: 44px;
        height: 52px;
        border-radius: 14px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
      }

      html[data-mode="dark"] .impressionsLightboxBtn {
        background: rgba(255, 255, 255, 0.06);
      }

      .impressionsLightboxBtn span {
        font-size: 26px;
        font-weight: 900;
        line-height: 1;
      }

      .impressionsLightboxClose {
        position: absolute;
        top: 10px;
        right: 14px;
        width: 38px;
        height: 38px;
        border-radius: 12px;
        border: 1px solid var(--border);
        background: var(--card);
        color: var(--text);
        cursor: pointer;
        display: grid;
        place-items: center;
      }

      .impressionsLightboxClose span {
        font-size: 22px;
        font-weight: 900;
        line-height: 1;
      }

      body.isImpressionsOpen {
        overflow: hidden;
      }

      @media (max-width: 900px) {
        .impressionsFrame {
          height: 260px;
        }

        .impressionsImg {
          contain-intrinsic-size: 260px 1020px;
        }
      }

      @media (max-width: 700px) {
        .impressionsShell {
          grid-template-columns: 44px 1fr 44px;
        }

        .impressionsArrow {
          width: 44px;
          height: 44px;
        }

        .impressionsArrow span {
          font-size: 30px;
        }

        .impressionsFrame {
          height: 220px;
        }

        .impressionsImg {
          contain-intrinsic-size: 220px 1020px;
        }

        .impressionsLightboxInner {
          grid-template-columns: 44px 1fr 44px;
          padding: 12px;
        }

        .impressionsLightboxBtn {
          width: 38px;
          height: 46px;
        }
      }
    </style>

    <script is:inline define:vars={{ items, loop }}>
      ;(() => {
        const root = document.querySelector('[data-impressions-root]')
        if (!root) return

        const viewport = root.querySelector('[data-viewport]')
        const track = root.querySelector('[data-track]')
        const prev = root.querySelector('[data-prev]')
        const next = root.querySelector('[data-next]')
        const lightbox = root.querySelector('[data-lightbox]')

        if (!viewport || !track || !prev || !next || !lightbox) return

        if (lightbox.parentElement !== document.body) document.body.appendChild(lightbox)

        const slides = Array.from(track.querySelectorAll('[data-slide-index]'))
        if (slides.length === 0) return

        const lbImg = lightbox.querySelector('[data-lb-img]')
        const lbCap = lightbox.querySelector('[data-lb-cap]')
        const lbPrev = lightbox.querySelector('[data-lb-prev]')
        const lbNext = lightbox.querySelector('[data-lb-next]')
        const lbClose = Array.from(lightbox.querySelectorAll('[data-close]'))

        const slideWidth = () => viewport.clientWidth || 1

        const realCount = loop ? slides.length - 2 : slides.length
        const realToSlideIndex = (realIndex) => (loop ? realIndex + 1 : realIndex)
        const slideIndexToReal = (slideIndex) => {
          if (!loop) return Math.max(0, Math.min(realCount - 1, slideIndex))
          if (slideIndex === 0) return realCount - 1
          if (slideIndex === slides.length - 1) return 0
          return slideIndex - 1
        }

        let realIndex = 0
        let syncing = false
        let scrollTimer = 0

        const preloadReal = (idx) => {
          const it = items[idx]
          if (!it || !it.src) return
          const img = new Image()
          img.decoding = 'async'
          img.loading = 'eager'
          img.src = it.src
        }

        const preloadAround = () => {
          if (realCount <= 1) return
          preloadReal((realIndex + 1) % realCount)
          preloadReal((realIndex - 1 + realCount) % realCount)
        }

        const scrollToSlideIndex = (slideIndex, smooth) => {
          const x = slideIndex * slideWidth()
          syncing = true
          viewport.scrollTo({ left: x, behavior: smooth ? 'smooth' : 'auto' })
          window.setTimeout(() => { syncing = false }, smooth ? 260 : 0)
        }

        const scrollToReal = (targetReal, smooth) => {
          const wrapped = ((targetReal % realCount) + realCount) % realCount
          realIndex = wrapped
          scrollToSlideIndex(realToSlideIndex(realIndex), smooth)
        }

        const snapFixIfOnClone = () => {
          if (!loop) return
          const w = slideWidth()
          if (w <= 1) return
          const slideIndex = Math.round(viewport.scrollLeft / w)
          if (slideIndex === 0) {
            scrollToSlideIndex(realToSlideIndex(realCount - 1), false)
            realIndex = realCount - 1
          } else if (slideIndex === slides.length - 1) {
            scrollToSlideIndex(realToSlideIndex(0), false)
            realIndex = 0
          } else {
            realIndex = slideIndexToReal(slideIndex)
          }
        }

        const onScroll = () => {
          if (syncing) return

          if (loop) {
            const max = viewport.scrollWidth - viewport.clientWidth
            if (viewport.scrollLeft <= 1 || viewport.scrollLeft >= max - 1) {
              snapFixIfOnClone()
              return
            }
          }

          if (scrollTimer) window.clearTimeout(scrollTimer)
          scrollTimer = window.setTimeout(() => {
            snapFixIfOnClone()
            preloadAround()
          }, 70)
        }

        viewport.addEventListener('scroll', onScroll, { passive: true })

        prev.addEventListener('click', (e) => {
          e.preventDefault()
          e.stopPropagation()
          scrollToReal(realIndex - 1, true)
          window.setTimeout(preloadAround, 80)
        })

        next.addEventListener('click', (e) => {
          e.preventDefault()
          e.stopPropagation()
          scrollToReal(realIndex + 1, true)
          window.setTimeout(preloadAround, 80)
        })

        const setLightboxOpen = (open) => {
          lightbox.classList.toggle('isOpen', open)
          lightbox.setAttribute('aria-hidden', open ? 'false' : 'true')
          document.body.classList.toggle('isImpressionsOpen', open)
        }

        const renderLightbox = () => {
          const it = items[realIndex]
          if (!it) return
          if (lbImg) {
            lbImg.src = it.full || it.src || ''
            lbImg.alt = it.alt || ''
          }
          if (lbCap) lbCap.textContent = it.caption || ''
          preloadAround()
        }

        const open = (idx) => {
          realIndex = ((idx % realCount) + realCount) % realCount
          renderLightbox()
          setLightboxOpen(true)
        }

        slides.forEach((slide) => {
          slide.addEventListener('click', (e) => {
            e.preventDefault()
            e.stopPropagation()
            const idx = Number(slide.getAttribute('data-real-index') || '0')
            if (!Number.isNaN(idx)) open(idx)
          })
        })

        if (lbPrev) lbPrev.addEventListener('click', (e) => {
          e.preventDefault()
          e.stopPropagation()
          scrollToReal(realIndex - 1, true)
          renderLightbox()
        })

        if (lbNext) lbNext.addEventListener('click', (e) => {
          e.preventDefault()
          e.stopPropagation()
          scrollToReal(realIndex + 1, true)
          renderLightbox()
        })

        if (lbClose && lbClose.length) {
          lbClose.forEach((b) => b.addEventListener('click', (e) => {
            e.preventDefault()
            e.stopPropagation()
            setLightboxOpen(false)
          }))
        }

        document.addEventListener('keydown', (event) => {
          if (lightbox.getAttribute('aria-hidden') === 'true') return
          if (event.key === 'Escape') setLightboxOpen(false)
          if (event.key === 'ArrowLeft') { scrollToReal(realIndex - 1, true); renderLightbox() }
          if (event.key === 'ArrowRight') { scrollToReal(realIndex + 1, true); renderLightbox() }
        })

        scrollToReal(0, false)
        window.setTimeout(preloadAround, 120)

        window.addEventListener('resize', () => {
          scrollToReal(realIndex, false)
          preloadAround()
        }, { passive: true })
      })()
    </script>
  </section>
) : null}