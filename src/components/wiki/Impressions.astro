---
const withBase = (path) => {
  if (!path) return ""
  if (path.startsWith("http://") || path.startsWith("https://")) return path

  const base = import.meta.env.BASE_URL || "/"
  const cleanBase = base.endsWith("/") ? base.slice(0, -1) : base
  const cleanPath = path.startsWith("/") ? path : `/${path}`

  return `${cleanBase}${cleanPath}`
}

const {
  id = "impressions",
  title = "Impressions",
  subtitle = "A quick look at how it feels ingame",
  images = [],
} = Astro.props

const normalized = Array.isArray(images) ? images.filter(Boolean) : []
const items = normalized.map((img, index) => {
  if (typeof img === "string") {
    const src = withBase(img)
    return { src, full: src, caption: "", alt: `Impression ${index + 1}` }
  }

  const src = withBase(img.src ?? "")
  const full = withBase((img.full ?? img.src) ?? "")
  const caption = String(img.caption ?? "")
  const alt = String(img.alt ?? (caption || `Impression ${index + 1}`))

  return { src, full: full || src, caption, alt }
})

const hasImages = items.length > 0
---

{hasImages ? (
  <section class="impressionsSection" id={id} data-section={id}>
    <div class="wikiSectionHeader">
      <div class="sectionTitle">
        <span>{title}</span>
      </div>
      {subtitle ? <p class="sectionSubtitle">{subtitle}</p> : null}
    </div>

    <div class="impressionsShell" data-impressions-shell>
      <button class="impressionsArrow impressionsArrowLeft" type="button" aria-label="Previous" data-impressions-prev>
        <span aria-hidden="true">‹</span>
      </button>

      <div class="impressionsViewport" data-impressions-viewport aria-label="Impressions">
        <div class="impressionsTrack" data-impressions-track>
          {items.length > 1 ? (
            <button
              class="impressionsSlide"
              type="button"
              data-impressions-open
              data-slide="clone-last"
              aria-label={items[items.length - 1]?.alt ?? "Open"}
            >
              <img class="impressionsImg" src={items[items.length - 1]?.src ?? ""} alt={items[items.length - 1]?.alt ?? ""} loading="lazy" />
              <div class="impressionsCaption">{items[items.length - 1]?.caption ?? ""}</div>
            </button>
          ) : null}

          {items.map((it, i) => (
            <button class="impressionsSlide" type="button" data-impressions-open data-slide-index={String(i)} aria-label={it.alt || "Open"}>
              <img class="impressionsImg" src={it.src} alt={it.alt} loading="lazy" />
              <div class="impressionsCaption">{it.caption}</div>
            </button>
          ))}

          {items.length > 1 ? (
            <button
              class="impressionsSlide"
              type="button"
              data-impressions-open
              data-slide="clone-first"
              aria-label={items[0]?.alt ?? "Open"}
            >
              <img class="impressionsImg" src={items[0]?.src ?? ""} alt={items[0]?.alt ?? ""} loading="lazy" />
              <div class="impressionsCaption">{items[0]?.caption ?? ""}</div>
            </button>
          ) : null}
        </div>
      </div>

      <button class="impressionsArrow impressionsArrowRight" type="button" aria-label="Next" data-impressions-next>
        <span aria-hidden="true">›</span>
      </button>
    </div>

    <div class="impressionsLightbox" data-impressions-lightbox aria-hidden="true">
      <button class="impressionsLightboxBackdrop" type="button" aria-label="Close" data-impressions-close></button>

      <div class="impressionsLightboxInner" role="dialog" aria-modal="true" aria-label="Impressions">
        <button class="impressionsLightboxBtn impressionsLightboxPrev" type="button" aria-label="Previous" data-impressions-lb-prev>
          <span aria-hidden="true">‹</span>
        </button>

        <figure class="impressionsLightboxFigure">
          <img class="impressionsLightboxImg" data-impressions-lb-img alt="" />
          <figcaption class="impressionsLightboxCaption" data-impressions-lb-cap></figcaption>
        </figure>

        <button class="impressionsLightboxBtn impressionsLightboxNext" type="button" aria-label="Next" data-impressions-lb-next>
          <span aria-hidden="true">›</span>
        </button>

        <button class="impressionsLightboxClose" type="button" aria-label="Close" data-impressions-close>
          <span aria-hidden="true">×</span>
        </button>
      </div>
    </div>

    <script is:inline define:vars={{ items }}>
      ;(() => {
        const shell = document.querySelector('[data-impressions-shell]')
        const lightbox = document.querySelector('[data-impressions-lightbox]')
        const viewport = document.querySelector('[data-impressions-viewport]')
        const track = document.querySelector('[data-impressions-track]')

        if (!shell || !viewport || !track || !Array.isArray(items) || items.length === 0) return

        if (lightbox && lightbox.parentElement !== document.body) {
          document.body.appendChild(lightbox)
        }

        const prev = shell.querySelector('[data-impressions-prev]')
        const next = shell.querySelector('[data-impressions-next]')

        const lbImg = lightbox ? lightbox.querySelector('[data-impressions-lb-img]') : null
        const lbCap = lightbox ? lightbox.querySelector('[data-impressions-lb-cap]') : null
        const lbPrev = lightbox ? lightbox.querySelector('[data-impressions-lb-prev]') : null
        const lbNext = lightbox ? lightbox.querySelector('[data-impressions-lb-next]') : null
        const lbClose = lightbox ? lightbox.querySelectorAll('[data-impressions-close]') : []

        const hasLoop = items.length > 1
        const slideWidth = () => viewport.clientWidth || 1

        let index = 0
        let scrollEndTimer = 0
        let syncing = false

        const wrap = (i) => {
          const len = items.length
          if (len <= 0) return 0
          return ((i % len) + len) % len
        }

        const setLightboxOpen = (open) => {
          if (!lightbox) return
          lightbox.setAttribute('aria-hidden', open ? 'false' : 'true')
          lightbox.classList.toggle('isOpen', open)
          document.body.classList.toggle('isImpressionsOpen', open)
        }

        const renderLightbox = () => {
          const it = items[index]
          if (!it) return
          if (lbImg) {
            lbImg.src = it.full || it.src || ''
            lbImg.alt = it.alt || ''
          }
          if (lbCap) lbCap.textContent = it.caption || ''
        }

        const scrollToRealIndex = (realIndex, smooth) => {
          index = wrap(realIndex)
          const offsetSlides = hasLoop ? 1 : 0
          const target = (index + offsetSlides) * slideWidth()
          syncing = true
          viewport.scrollTo({ left: target, behavior: smooth ? 'smooth' : 'auto' })
          window.setTimeout(() => { syncing = false }, smooth ? 260 : 0)
        }

        const jumpToRealIndex = (realIndex) => {
          index = wrap(realIndex)
          const offsetSlides = hasLoop ? 1 : 0
          const target = (index + offsetSlides) * slideWidth()
          syncing = true
          viewport.scrollTo({ left: target, behavior: 'auto' })
          window.setTimeout(() => { syncing = false }, 0)
        }

        const syncIndexFromScroll = () => {
          const w = slideWidth()
          const raw = Math.round(viewport.scrollLeft / w)

          if (!hasLoop) {
            index = wrap(raw)
            return
          }

          const totalSlides = items.length + 2
          const lastClonePos = 0
          const firstRealPos = 1
          const lastRealPos = items.length
          const firstClonePos = totalSlides - 1

          if (raw === lastClonePos) {
            index = items.length - 1
            return
          }

          if (raw === firstClonePos) {
            index = 0
            return
          }

          const real = raw - 1
          index = wrap(real)
        }

        const maybeLoopJump = () => {
          if (!hasLoop) return
          const w = slideWidth()
          const raw = Math.round(viewport.scrollLeft / w)

          const totalSlides = items.length + 2
          const lastClonePos = 0
          const firstClonePos = totalSlides - 1

          if (raw === lastClonePos) {
            jumpToRealIndex(items.length - 1)
          } else if (raw === firstClonePos) {
            jumpToRealIndex(0)
          }
        }

        const onScroll = () => {
          if (syncing) return
          syncIndexFromScroll()
          if (scrollEndTimer) window.clearTimeout(scrollEndTimer)
          scrollEndTimer = window.setTimeout(() => {
            maybeLoopJump()
          }, 120)
        }

        viewport.addEventListener('scroll', onScroll, { passive: true })

        if (prev) prev.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); scrollToRealIndex(index - 1, true) })
        if (next) next.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); scrollToRealIndex(index + 1, true) })

        track.addEventListener('click', (e) => {
          const target = e.target instanceof Element ? e.target.closest('[data-impressions-open]') : null
          if (!target) return
          e.preventDefault()
          e.stopPropagation()

          const slideIndexAttr = target.getAttribute('data-slide-index')
          if (slideIndexAttr !== null) {
            const parsed = Number(slideIndexAttr)
            if (!Number.isNaN(parsed)) index = wrap(parsed)
          } else {
            const slideType = target.getAttribute('data-slide')
            if (slideType === 'clone-last') index = items.length - 1
            else if (slideType === 'clone-first') index = 0
          }

          renderLightbox()
          setLightboxOpen(true)
        })

        if (lbPrev) lbPrev.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); scrollToRealIndex(index - 1, true); renderLightbox() })
        if (lbNext) lbNext.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); scrollToRealIndex(index + 1, true); renderLightbox() })

        if (lbClose && lbClose.length) {
          lbClose.forEach((b) => b.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); setLightboxOpen(false) }))
        }

        document.addEventListener('keydown', (event) => {
          if (!lightbox || lightbox.getAttribute('aria-hidden') === 'true') return
          if (event.key === 'Escape') setLightboxOpen(false)
          if (event.key === 'ArrowLeft') { scrollToRealIndex(index - 1, true); renderLightbox() }
          if (event.key === 'ArrowRight') { scrollToRealIndex(index + 1, true); renderLightbox() }
        })

        const init = () => {
          if (hasLoop) {
            jumpToRealIndex(0)
          } else {
            scrollToRealIndex(0, false)
          }
        }

        init()
        window.addEventListener('resize', () => jumpToRealIndex(index), { passive: true })
      })()
    </script>
  </section>
) : null}