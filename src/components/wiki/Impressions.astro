---
const withBase = (path) => {
  if (!path) return ""
  if (path.startsWith("http://") || path.startsWith("https://")) return path
  const base = import.meta.env.BASE_URL || "/"
  const cleanBase = base.endsWith("/") ? base.slice(0, -1) : base
  const cleanPath = path.startsWith("/") ? path : `/${path}`
  return `${cleanBase}${cleanPath}`
}

const {
  id = "impressions",
  title = "Impressions",
  subtitle = "A quick look at how it feels ingame",
  images = [],
} = Astro.props

const normalized = Array.isArray(images) ? images.filter(Boolean) : []
const items = normalized.map((img, index) => {
  if (typeof img === "string") {
    const src = withBase(img)
    return { src, full: src, caption: "", alt: `Impression ${index + 1}` }
  }
  const src = withBase(img.src ?? "")
  const full = withBase((img.full ?? img.src) ?? "")
  const caption = String(img.caption ?? "")
  const alt = String(img.alt ?? (caption || `Impression ${index + 1}`))
  return { src, full: full || src, caption, alt }
})

const hasImages = items.length > 0
const loop = items.length > 1
const loopItems = loop ? [items[items.length - 1], ...items, items[0]] : items
---

{hasImages ? (
<section class="impressionsSection" id={id} data-impressions-root>
  <div class="wikiSectionHeader">
    <div class="sectionTitle">
      <span>{title}</span>
    </div>
    {subtitle ? <p class="sectionSubtitle">{subtitle}</p> : null}
  </div>

  <div class="impressionsShell" data-impressions-shell>
    <button class="impressionsArrow" data-prev type="button" aria-label="Previous">
      <span aria-hidden="true">‹</span>
    </button>

    <div class="impressionsViewport" data-viewport>
      <div class="impressionsTrack" data-track>
        {loopItems.map((it, i) => {
          const realIndex = loop ? (i === 0 ? items.length - 1 : i === loopItems.length - 1 ? 0 : i - 1) : i
          return (
            <button class="impressionsSlide" type="button" data-open data-real-index={String(realIndex)} data-slide-index={String(i)}>
              <div class="impressionsFrame">
                <img class="impressionsImg" src={it.src} alt={it.alt} loading="lazy" />
              </div>
              <div class="impressionsCaption">{it.caption}</div>
            </button>
          )
        })}
      </div>
    </div>

    <button class="impressionsArrow" data-next type="button" aria-label="Next">
      <span aria-hidden="true">›</span>
    </button>
  </div>

  <style is:inline>
    .impressionsSection {
      margin-top: 56px;
      margin-bottom: 28px;
    }

    .impressionsShell {
      width: 100%;
      max-width: 1020px;
      margin: 0 auto;
      display: grid;
      grid-template-columns: 52px 1fr 52px;
      align-items: center;
      gap: 14px;
    }

    .impressionsViewport {
      width: 100%;
      overflow-x: auto;
      overflow-y: hidden;
      scroll-snap-type: x mandatory;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-x: contain;
      overscroll-behavior-y: none;
      scrollbar-width: none;
    }

    .impressionsViewport::-webkit-scrollbar {
      display: none;
    }

    .impressionsTrack {
      display: flex;
      width: 100%;
    }

    .impressionsSlide {
      flex: 0 0 100%;
      scroll-snap-align: start;
      scroll-snap-stop: always;
      border: 0;
      background: transparent;
      padding: 0;
      margin: 0;
      display: grid;
      justify-items: center;
      gap: 10px;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
    }

    .impressionsSlide:focus,
    .impressionsSlide:focus-visible {
      outline: none;
    }

    .impressionsFrame {
      width: 100%;
      height: 320px;
      border-radius: 22px;
      overflow: hidden;
    }

    .impressionsImg {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
    }

    .impressionsCaption {
      font-size: 14px;
      color: var(--muted);
      text-align: center;
      min-height: 18px;
    }

    .impressionsArrow {
      width: 52px;
      height: 52px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: var(--card);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
    }

    .impressionsArrow:focus,
    .impressionsArrow:focus-visible {
      outline: none;
    }

    .impressionsArrow span {
      font-size: 34px;
      font-weight: 900;
      line-height: 1;
    }

    @media (max-width: 900px) {
      .impressionsFrame {
        height: 260px;
      }
    }

    @media (max-width: 700px) {
      .impressionsShell {
        grid-template-columns: 44px 1fr 44px;
      }

      .impressionsArrow {
        width: 44px;
        height: 44px;
      }

      .impressionsArrow span {
        font-size: 30px;
      }

      .impressionsFrame {
        height: 220px;
      }
    }
  </style>

  <script is:inline define:vars={{ loop }}>
    ;(() => {
      const root = document.querySelector('[data-impressions-root]')
      if (!root) return

      const viewport = root.querySelector('[data-viewport]')
      const track = root.querySelector('[data-track]')
      const prev = root.querySelector('[data-prev]')
      const next = root.querySelector('[data-next]')
      if (!viewport || !track || !prev || !next) return

      const slides = Array.from(track.querySelectorAll('[data-slide-index]'))
      if (slides.length === 0) return

      const slideWidth = () => viewport.clientWidth || 1

      const realCount = loop ? slides.length - 2 : slides.length
      const realToSlideIndex = (realIndex) => (loop ? realIndex + 1 : realIndex)
      const slideIndexToReal = (slideIndex) => {
        if (!loop) return Math.max(0, Math.min(realCount - 1, slideIndex))
        if (slideIndex === 0) return realCount - 1
        if (slideIndex === slides.length - 1) return 0
        return slideIndex - 1
      }

      let realIndex = 0
      let syncing = false
      let scrollTimer = 0

      const scrollToSlideIndex = (slideIndex, smooth) => {
        const x = slideIndex * slideWidth()
        syncing = true
        viewport.scrollTo({ left: x, behavior: smooth ? 'smooth' : 'auto' })
        window.setTimeout(() => { syncing = false }, smooth ? 260 : 0)
      }

      const scrollToReal = (targetReal, smooth) => {
        const wrapped = ((targetReal % realCount) + realCount) % realCount
        realIndex = wrapped
        scrollToSlideIndex(realToSlideIndex(realIndex), smooth)
      }

      const snapFixIfOnClone = () => {
        if (!loop) return
        const w = slideWidth()
        const slideIndex = Math.round(viewport.scrollLeft / w)
        if (slideIndex === 0) {
          scrollToSlideIndex(realToSlideIndex(realCount - 1), false)
          realIndex = realCount - 1
        } else if (slideIndex === slides.length - 1) {
          scrollToSlideIndex(realToSlideIndex(0), false)
          realIndex = 0
        } else {
          realIndex = slideIndexToReal(slideIndex)
        }
      }

      const onScroll = () => {
        if (syncing) return
        if (scrollTimer) window.clearTimeout(scrollTimer)
        scrollTimer = window.setTimeout(snapFixIfOnClone, 120)
      }

      viewport.addEventListener('scroll', onScroll, { passive: true })

      prev.addEventListener('click', (e) => {
        e.preventDefault()
        e.stopPropagation()
        scrollToReal(realIndex - 1, true)
      })

      next.addEventListener('click', (e) => {
        e.preventDefault()
        e.stopPropagation()
        scrollToReal(realIndex + 1, true)
      })

      const init = () => {
        scrollToReal(0, false)
      }

      init()

      window.addEventListener('resize', () => {
        scrollToReal(realIndex, false)
      }, { passive: true })
    })()
  </script>
</section>
) : null}