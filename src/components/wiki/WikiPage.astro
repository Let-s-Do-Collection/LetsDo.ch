---
import SiteLayout from "../../layouts/SiteLayout.astro";
import NavBar from "../NavBar.astro";
import Footer from "../Footer.astro";
import "../../styles/mods.css";
import "../../styles/wiki.css";

const withBase = (path) => {
  if (!path) return "";
  if (path.startsWith("http://") || path.startsWith("https://")) return path;

  const base = import.meta.env.BASE_URL || "/";
  const cleanBase = base.endsWith("/") ? base.slice(0, -1) : base;
  const cleanPath = path.startsWith("/") ? path : `/${path}`;

  return `${cleanBase}${cleanPath}`;
};

const { config, currentSlug, wikiIndex } = Astro.props;

const title = config?.title ?? "Wiki";
const logo = config?.logo ?? "";
const aboutTitle = config?.aboutTitle ?? "Welcome";
const aboutSubtitle = config?.aboutSubtitle ?? "";
const aboutText = config?.aboutText ?? "";
const sections = Array.isArray(config?.sections) ? config.sections : [];
const wikis = Array.isArray(wikiIndex) ? wikiIndex : [];

const activeSlug = typeof currentSlug === "string" ? currentSlug : "";
const activeWiki = wikis.find((w) => w.slug === activeSlug) ?? null;
const activeWikiTitle = activeWiki?.title ?? title;

const searchPlaceholder = "Search items, blocks, features...";

const entrySearch = (entry) =>
  `${entry.title ?? ""} ${entry.subtitle ?? ""} ${entry.namespace_id ?? ""} ${entry.search ?? ""}`.toLowerCase();

const entryHasDetails = (entry) =>
  Boolean(entry.details) ||
  Boolean(entry.detailsTitle) ||
  Boolean(entry.detailsText) ||
  (Array.isArray(entry.detailsBullets) && entry.detailsBullets.length) ||
  (Array.isArray(entry.detailsIds) && entry.detailsIds.length) ||
  (Array.isArray(entry.detailsGallery) && entry.detailsGallery.length) ||
  (Array.isArray(entry.items) && entry.items.length);

const titleCaseFromId = (id) =>
  String(id ?? "")
    .split("_")
    .filter(Boolean)
    .map((p) => p.slice(0, 1).toUpperCase() + p.slice(1))
    .join(" ");

const wikiHref = (slug) => withBase(`/wiki/${slug}/`);
---

<SiteLayout title={title}>
  <NavBar />

  <main class="page wikiLayout">
    <aside class="wikiSidebar">
      <div class="wikiSidebarInner">
        <div class="wikiDropdown" id="wikiDropdown" data-open="false">
          <button
            class="wikiDropdownButton"
            id="wikiDropdownButton"
            type="button"
            aria-haspopup="menu"
            aria-expanded="false"
          >
            <span class="wikiDropdownLabel" id="wikiDropdownLabel">{activeWikiTitle}</span>
            <span class="wikiDropdownChevron" aria-hidden="true"></span>
          </button>

          <div class="wikiDropdownMenu" id="wikiDropdownMenu" role="menu" hidden>
            {wikis.map((w) => (
              <a
                class={`wikiDropdownItem ${w.slug === activeSlug ? "isActive" : ""}`}
                href={wikiHref(w.slug)}
                role="menuitem"
                data-wiki-slug={w.slug}
              >
                <span class="wikiDropdownItemTitle">{w.title}</span>
                {w.slug === activeSlug ? <span class="wikiDropdownCheck" aria-hidden="true">âœ“</span> : null}
              </a>
            ))}
          </div>
        </div>

        <div class="wikiSideSearch">
          <input
            id="wikiSearchInput"
            class="wikiSideSearchInput"
            type="search"
            placeholder={searchPlaceholder}
            autocomplete="off"
            spellcheck="false"
          />
        </div>

        <div class="wikiSideHeading">Content</div>

        <nav class="wikiSideNav">
          {sections.map((section) => (
            <a class="wikiSideLink" href={`#${section.id}`} data-section-link={section.id}>
              {section.title}
            </a>
          ))}
        </nav>
      </div>
    </aside>

    <div class="wikiMain">
      <section class="section sectionCentered">
        <div class="aboutHero modsHero wikiHero">
          {logo ? <img class="wikiHeroLogo" src={withBase(logo)} alt={title} loading="eager" /> : null}
        </div>
      </section>

      <section class="section sectionCentered sectionTight">
        <div class="sectionTitle">
          <span>{aboutTitle}</span>
        </div>

        {aboutSubtitle ? <p class="sectionSubtitle">{aboutSubtitle}</p> : null}

        {aboutText ? <div class="aboutText">{aboutText}</div> : null}
      </section>

      {sections.map((section) => (
        <section class="section sectionCentered sectionTight wikiSection" id={section.id} data-section={section.id}>
          <div class="wikiSectionHeader">
            <div class="sectionTitle">
              <span>{section.title}</span>
            </div>

            {section.subtitle ? <p class="sectionSubtitle">{section.subtitle}</p> : null}
          </div>

          <div class="gridWrapper">
            <div class="grid wikiGrid">
              {(section.entries ?? []).map((entry) => {
                const hasDetails = entryHasDetails(entry);
                const iconSrc = entry.icon ? withBase(entry.icon) : "";
                const detailsOpenTitle = entry.detailsTitle ?? "Details";

                return (
                  <article
                    class="card wikiCard"
                    data-section={section.id}
                    data-search={entrySearch(entry)}
                    data-has-details={hasDetails ? "true" : "false"}
                  >
                    <div class="cardContent wikiCardContent">
                      {iconSrc ? (
                        <img class="cardLogo wikiCardLogo" src={iconSrc} alt={entry.title} loading="lazy" />
                      ) : (
                        <div class="wikiCardLogoPlaceholder" aria-hidden="true" />
                      )}

                      <h3>{entry.title}</h3>

                      {entry.namespace_id ? <div class="wikiCardNs">{entry.namespace_id}</div> : null}

                      {entry.subtitle ? <p>{entry.subtitle}</p> : null}
                    </div>

                    {hasDetails ? (
                      <div class="wikiCardDetails" aria-hidden="true">
                        <div class="wikiDetailsHeader">
                          <div class="wikiDetailsTitle">{detailsOpenTitle}</div>
                          {entry.detailsSubtitle ? <div class="wikiDetailsSubtitle">{entry.detailsSubtitle}</div> : null}
                        </div>

                        {entry.detailsText ? <div class="wikiDetailsText">{entry.detailsText}</div> : null}

                        {Array.isArray(entry.detailsIds) && entry.detailsIds.length ? (
                          <div class="wikiDetailsIds">
                            {entry.detailsIds.map((id) => (
                              <div class="wikiDetailsId">{id}</div>
                            ))}
                          </div>
                        ) : null}

                        {Array.isArray(entry.detailsGallery) && entry.detailsGallery.length ? (
                          <div class="wikiDetailsGallery">
                            {entry.detailsGallery.map((g) => (
                              <div class="wikiGalleryItem">
                                <img
                                  class="wikiGalleryImg"
                                  src={g.icon ? withBase(g.icon) : ""}
                                  alt={g.title ?? ""}
                                  loading="lazy"
                                />
                                <div class="wikiGalleryMeta">
                                  <div class="wikiGalleryTitle">{g.title ?? ""}</div>
                                  {g.namespace_id ? <div class="wikiGalleryNs">{g.namespace_id}</div> : null}
                                </div>
                              </div>
                            ))}
                          </div>
                        ) : null}

                        {Array.isArray(entry.detailsBullets) && entry.detailsBullets.length ? (
                          <ul class="wikiDetailsList">
                            {entry.detailsBullets.map((line) => (
                              <li>{line}</li>
                            ))}
                          </ul>
                        ) : null}

                        {Array.isArray(entry.items) && entry.items.length ? (
                          <div class="wikiMiniGrid">
                            {entry.items.map((it) => (
                              <article class="wikiMiniCard" data-search={entrySearch(it)}>
                                <img
                                  class="wikiMiniIcon"
                                  src={it.icon ? withBase(it.icon) : ""}
                                  alt={it.title ?? ""}
                                  loading="lazy"
                                />
                                <div class="wikiMiniBody">
                                  <div class="wikiMiniTitle">{it.title ?? titleCaseFromId(it.id)}</div>
                                  {it.namespace_id ? <div class="wikiMiniNs">{it.namespace_id}</div> : null}
                                  {it.subtitle ? <div class="wikiMiniSub">{it.subtitle}</div> : null}
                                </div>
                              </article>
                            ))}
                          </div>
                        ) : null}
                      </div>
                    ) : null}

                    <div class="cardAction">
                      {hasDetails ? (
                        <button class="btn btnSecondary wikiToggle" type="button" aria-expanded="false">
                          More info
                        </button>
                      ) : null}

                      {entry.wikiHref ? (
                        <a class="btn btnPrimary" href={entry.wikiHref}>
                          View
                        </a>
                      ) : null}
                    </div>
                  </article>
                );
              })}
            </div>
          </div>

          <div class="modsEmpty" data-empty-for={section.id} style="display:none;">
            No results in {section.title}.
          </div>
        </section>
      ))}
    </div>
  </main>

  <Footer />

  <script is:inline>
    const input = document.getElementById("wikiSearchInput");
    const cards = Array.from(document.querySelectorAll(".wikiCard[data-search]"));
    const sections = Array.from(document.querySelectorAll(".wikiSection"));
    const sectionLinks = Array.from(document.querySelectorAll("[data-section-link]"));

    const dropdown = document.getElementById("wikiDropdown");
    const dropdownButton = document.getElementById("wikiDropdownButton");
    const dropdownMenu = document.getElementById("wikiDropdownMenu");

    const setDropdownOpen = (open) => {
      if (!dropdown || !dropdownButton || !dropdownMenu) return;
      dropdown.dataset.open = open ? "true" : "false";
      dropdownButton.setAttribute("aria-expanded", open ? "true" : "false");
      dropdownMenu.hidden = !open;
    };

    if (dropdownButton && dropdownMenu) {
      dropdownButton.addEventListener("click", (event) => {
        event.preventDefault();
        const openNow = dropdown.dataset.open === "true";
        setDropdownOpen(!openNow);
      });

      dropdownMenu.addEventListener("click", (event) => {
        const link = event.target.closest("a");
        if (!link) return;
        setDropdownOpen(false);
      });

      document.addEventListener("click", (event) => {
        if (!dropdown) return;
        if (dropdown.contains(event.target)) return;
        setDropdownOpen(false);
      });

      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") setDropdownOpen(false);
      });
    }

    const setOpen = (card, open) => {
      const details = card.querySelector(".wikiCardDetails");
      const toggle = card.querySelector(".wikiToggle");
      if (!details || !toggle) return;

      card.classList.toggle("isOpen", open);
      card.classList.toggle("isExpanded", open);

      details.setAttribute("aria-hidden", open ? "false" : "true");
      toggle.setAttribute("aria-expanded", open ? "true" : "false");
      toggle.textContent = open ? "Less info" : "More info";

      if (open) {
        for (const other of cards) {
          if (other !== card) {
            other.classList.remove("isOpen", "isExpanded");
            const otherDetails = other.querySelector(".wikiCardDetails");
            const otherToggle = other.querySelector(".wikiToggle");
            if (otherDetails) otherDetails.setAttribute("aria-hidden", "true");
            if (otherToggle) {
              otherToggle.setAttribute("aria-expanded", "false");
              otherToggle.textContent = "More info";
            }
          }
        }
      }
    };

    document.addEventListener("click", (event) => {
      const toggle = event.target.closest(".wikiToggle");
      if (!toggle) return;

      const card = toggle.closest(".wikiCard");
      if (!card) return;

      const open = !card.classList.contains("isOpen");
      setOpen(card, open);

      if (open) {
        requestAnimationFrame(() => {
          card.scrollIntoView({ behavior: "smooth", block: "center" });
        });
      }
    });

    const updateActiveSection = () => {
      const fromTop = window.scrollY + 140;
      let active = null;

      for (const section of sections) {
        if (section.offsetTop <= fromTop) active = section;
      }

      const activeId = active ? active.id : null;
      for (const link of sectionLinks) {
        link.classList.toggle("isActive", link.getAttribute("data-section-link") === activeId);
      }
    };

    const update = () => {
      const q = (input.value || "").trim().toLowerCase();
      const visiblePerSection = new Map();

      for (const card of cards) {
        const hay = card.getAttribute("data-search") || "";
        const show = q.length === 0 || hay.includes(q);
        card.style.display = show ? "" : "none";

        if (!show) setOpen(card, false);

        const sectionId = card.getAttribute("data-section");
        if (show) visiblePerSection.set(sectionId, (visiblePerSection.get(sectionId) || 0) + 1);
      }

      for (const section of sections) {
        const sectionId = section.id;
        const count = visiblePerSection.get(sectionId) || 0;
        const emptyEl = section.querySelector(`[data-empty-for="${sectionId}"]`);
        if (emptyEl) emptyEl.style.display = count === 0 ? "" : "none";
      }
    };

    input.addEventListener("input", update);
    window.addEventListener("scroll", updateActiveSection, { passive: true });

    update();
    updateActiveSection();
  </script>
</SiteLayout>