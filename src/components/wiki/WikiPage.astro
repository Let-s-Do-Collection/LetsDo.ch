---
import SiteLayout from "../../layouts/SiteLayout.astro";
import NavBar from "../NavBar.astro";
import Footer from "../Footer.astro";
import WikiRecipeGrid from "./WikiRecipeGrid.astro";

const withBase = (path) => {
  if (!path) return "";
  if (path.startsWith("http://") || path.startsWith("https://")) return path;

  const base = import.meta.env.BASE_URL || "/";
  const cleanBase = base.endsWith("/") ? base.slice(0, -1) : base;
  const cleanPath = path.startsWith("/") ? path : `/${path}`;

  return `${cleanBase}${cleanPath}`;
};

const { config } = Astro.props;

const title = config?.title ?? "Wiki";
const logo = config?.logo ?? "";
const aboutTitle = config?.aboutTitle ?? "Welcome";
const aboutSubtitle = config?.aboutSubtitle ?? "";
const aboutText = config?.aboutText ?? "";
const sections = Array.isArray(config?.sections) ? config.sections : [];

const searchPlaceholder = "Search items, blocks, features...";

const entrySearch = (entry) =>
  `${entry.title ?? ""} ${entry.subtitle ?? ""} ${entry.namespace_id ?? ""} ${entry.search ?? ""}`.toLowerCase();

const entryHasDetails = (entry) =>
  Boolean(entry.details) ||
  Boolean(entry.detailsTitle) ||
  Boolean(entry.detailsText) ||
  (Array.isArray(entry.detailsBullets) && entry.detailsBullets.length) ||
  (Array.isArray(entry.detailsIds) && entry.detailsIds.length) ||
  (Array.isArray(entry.detailsGallery) && entry.detailsGallery.length) ||
  (Array.isArray(entry.items) && entry.items.length) ||
  Boolean(entry.recipe);

const titleCaseFromId = (id) =>
  String(id ?? "")
    .split("_")
    .filter(Boolean)
    .map((p) => p.slice(0, 1).toUpperCase() + p.slice(1))
    .join(" ");
---

<SiteLayout title={title}>
  <link rel="stylesheet" href={withBase("/styles/mods.css")} />
  <link rel="stylesheet" href={withBase("/styles/wiki.css")} />

  <NavBar />

  <main class="page wikiLayout">
    <aside class="wikiSidebar">
      <div class="wikiSidebarInner">
        <div class="wikiSideTitle">{title}</div>

        <div class="wikiSideSearch">
          <input
            id="wikiSearchInput"
            class="wikiSideSearchInput"
            type="search"
            placeholder={searchPlaceholder}
            autocomplete="off"
            spellcheck="false"
          />
        </div>

        <div class="wikiSideHeading">Content</div>

        <nav class="wikiSideNav">
          {sections.map((section) => (
            <a class="wikiSideLink" href={`#${section.id}`} data-section-link={section.id}>
              {section.title}
            </a>
          ))}
        </nav>
      </div>
    </aside>

    <div class="wikiMain">
      <section class="section sectionCentered">
        <div class="aboutHero modsHero wikiHero">
          {logo ? <img class="wikiHeroLogo" src={withBase(logo)} alt={title} loading="eager" /> : null}
        </div>
      </section>

      <section class="section sectionCentered sectionTight">
        <div class="sectionTitle">
          <span>{aboutTitle}</span>
        </div>

        {aboutSubtitle ? <p class="sectionSubtitle">{aboutSubtitle}</p> : null}

        {aboutText ? <div class="aboutText">{aboutText}</div> : null}
      </section>

      {sections.map((section) => (
        <section class="section sectionCentered sectionTight wikiSection" id={section.id} data-section={section.id}>
          <div class="wikiSectionHeader">
            <div class="sectionTitle">
              <span>{section.title}</span>
            </div>

            {section.subtitle ? <p class="sectionSubtitle">{section.subtitle}</p> : null}
          </div>

          <div class="gridWrapper">
            <div class="grid wikiGrid">
              {(section.entries ?? []).map((entry) => {
                const hasDetails = entryHasDetails(entry);
                const iconSrc = entry.icon ? withBase(entry.icon) : "";
                const detailsOpenTitle = entry.detailsTitle ?? "Details";
                const detailsSubtitle = entry.detailsSubtitle ?? "";

                const showHeader = Boolean(detailsOpenTitle) || Boolean(detailsSubtitle);

                return (
                  <article
                    class="card wikiCard"
                    data-section={section.id}
                    data-search={entrySearch(entry)}
                    data-has-details={hasDetails ? "true" : "false"}
                  >
                    <div class="cardContent wikiCardContent">
                      {iconSrc ? (
                        <img class="cardLogo wikiCardLogo" src={iconSrc} alt={entry.title} loading="lazy" />
                      ) : (
                        <div class="wikiCardLogoPlaceholder" aria-hidden="true" />
                      )}

                      <h3>{entry.title}</h3>

                      {entry.namespace_id ? <div class="wikiCardNs">{entry.namespace_id}</div> : null}

                      {entry.subtitle ? <p>{entry.subtitle}</p> : null}
                    </div>

                    {hasDetails ? (
                      <div class="wikiCardDetails" aria-hidden="true">
                        {showHeader ? (
                          <div class="wikiDetailsHeader">
                            {detailsOpenTitle ? <div class="wikiDetailsTitle">{detailsOpenTitle}</div> : null}
                            {detailsSubtitle ? <div class="wikiDetailsSubtitle">{detailsSubtitle}</div> : null}
                          </div>
                        ) : null}

                        {entry.detailsText ? <div class="wikiDetailsText">{entry.detailsText}</div> : null}

                        {entry.recipe ? <WikiRecipeGrid recipe={entry.recipe} /> : null}

                        {Array.isArray(entry.detailsIds) && entry.detailsIds.length ? (
                          <div class="wikiDetailsIds">
                            {entry.detailsIds.map((id) => (
                              <div class="wikiDetailsId">{id}</div>
                            ))}
                          </div>
                        ) : null}

                        {Array.isArray(entry.detailsGallery) && entry.detailsGallery.length ? (
                          <div class="wikiDetailsGallery">
                            {entry.detailsGallery.map((g) => (
                              <div class="wikiGalleryItem">
                                <img
                                  class="wikiGalleryImg"
                                  src={g.icon ? withBase(g.icon) : ""}
                                  alt={g.title ?? ""}
                                  loading="lazy"
                                />
                                <div class="wikiGalleryMeta">
                                  <div class="wikiGalleryTitle">{g.title ?? ""}</div>
                                  {g.namespace_id ? <div class="wikiGalleryNs">{g.namespace_id}</div> : null}
                                </div>
                              </div>
                            ))}
                          </div>
                        ) : null}

                        {Array.isArray(entry.detailsBullets) && entry.detailsBullets.length ? (
                          <ul class="wikiDetailsList">
                            {entry.detailsBullets.map((line) => (
                              <li>{line}</li>
                            ))}
                          </ul>
                        ) : null}

                        {Array.isArray(entry.items) && entry.items.length ? (
                          <div class="wikiMiniGrid">
                            {entry.items.map((it) => (
                              <article class="wikiMiniCard" data-search={entrySearch(it)}>
                                <img
                                  class="wikiMiniIcon"
                                  src={it.icon ? withBase(it.icon) : ""}
                                  alt={it.title ?? ""}
                                  loading="lazy"
                                />
                                <div class="wikiMiniBody">
                                  <div class="wikiMiniTitle">{it.title ?? titleCaseFromId(it.id)}</div>
                                  {it.namespace_id ? <div class="wikiMiniNs">{it.namespace_id}</div> : null}
                                  {it.subtitle ? <div class="wikiMiniSub">{it.subtitle}</div> : null}
                                </div>
                              </article>
                            ))}
                          </div>
                        ) : null}
                      </div>
                    ) : null}

                    <div class="cardAction">
                      {hasDetails ? (
                        <button class="btn btnSecondary wikiToggle" type="button" aria-expanded="false">
                          Show Recipe
                        </button>
                      ) : null}

                      {entry.wikiHref ? (
                        <a class="btn btnPrimary" href={entry.wikiHref}>
                          View
                        </a>
                      ) : null}
                    </div>
                  </article>
                );
              })}
            </div>
          </div>

          <div class="modsEmpty" data-empty-for={section.id} style="display:none;">
            No results in {section.title}.
          </div>
        </section>
      ))}
    </div>
  </main>

  <Footer />

  <script is:inline>
    const input = document.getElementById("wikiSearchInput");
    const cards = Array.from(document.querySelectorAll(".wikiCard[data-search]"));
    const sections = Array.from(document.querySelectorAll(".wikiSection"));
    const sectionLinks = Array.from(document.querySelectorAll("[data-section-link]"));

    const setOpen = (card, open) => {
      const details = card.querySelector(".wikiCardDetails");
      const toggle = card.querySelector(".wikiToggle");
      if (!details || !toggle) return;

      card.classList.toggle("isOpen", open);
      card.classList.toggle("isExpanded", open);

      details.setAttribute("aria-hidden", open ? "false" : "true");
      toggle.setAttribute("aria-expanded", open ? "true" : "false");
      toggle.textContent = open ? "Close" : "Show Recipe";

      if (open) {
        for (const other of cards) {
          if (other !== card) {
            other.classList.remove("isOpen", "isExpanded");
            const otherDetails = other.querySelector(".wikiCardDetails");
            const otherToggle = other.querySelector(".wikiToggle");
            if (otherDetails) otherDetails.setAttribute("aria-hidden", "true");
            if (otherToggle) {
              otherToggle.setAttribute("aria-expanded", "false");
              otherToggle.textContent = "Show Recipe";
            }
          }
        }
      }
    };

    document.addEventListener("click", (event) => {
      const toggle = event.target.closest(".wikiToggle");
      if (!toggle) return;

      const card = toggle.closest(".wikiCard");
      if (!card) return;

      const open = !card.classList.contains("isOpen");
      setOpen(card, open);

      if (open) {
        requestAnimationFrame(() => {
          card.scrollIntoView({ behavior: "smooth", block: "center" });
        });
      }
    });

    const updateActiveSection = () => {
      const fromTop = window.scrollY + 140;
      let active = null;

      for (const section of sections) {
        if (section.offsetTop <= fromTop) active = section;
      }

      const activeId = active ? active.id : null;
      for (const link of sectionLinks) {
        link.classList.toggle("isActive", link.getAttribute("data-section-link") === activeId);
      }
    };

    const update = () => {
      const q = (input.value || "").trim().toLowerCase();
      const visiblePerSection = new Map();

      for (const card of cards) {
        const hay = card.getAttribute("data-search") || "";
        const show = q.length === 0 || hay.includes(q);
        card.style.display = show ? "" : "none";

        if (!show) setOpen(card, false);

        const sectionId = card.getAttribute("data-section");
        if (show) visiblePerSection.set(sectionId, (visiblePerSection.get(sectionId) || 0) + 1);
      }

      for (const section of sections) {
        const sectionId = section.id;
        const count = visiblePerSection.get(sectionId) || 0;
        const emptyEl = section.querySelector(`[data-empty-for="${sectionId}"]`);
        if (emptyEl) emptyEl.style.display = count === 0 ? "" : "none";
      }
    };

    input.addEventListener("input", update);
    window.addEventListener("scroll", updateActiveSection, { passive: true });

    update();
    updateActiveSection();
  </script>

  <style>
    .wikiSidebarInner {
      width: 100%;
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: var(--card);
      box-shadow: var(--shadow);
      padding: 16px;
      display: grid;
      gap: 14px;
    }

    .wikiSideTitle {
      font-weight: 800;
      font-size: 16px;
      line-height: 1.2;
    }

    .wikiSideSearchInput {
      width: 100%;
      padding: 12px 12px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: rgba(0, 0, 0, 0.02);
      color: var(--text);
      font-size: 14px;
      outline: none;
    }

    .wikiSideSearchInput:focus {
      border-color: var(--borderStrong);
      background: var(--card);
    }

    .wikiSideHeading {
      font-size: 12px;
      color: var(--muted);
      letter-spacing: 0.2px;
      text-transform: uppercase;
      margin-top: 2px;
    }

    .wikiSideNav {
      display: grid;
      gap: 8px;
    }

    .wikiSideLink {
      text-decoration: none;
      color: var(--muted);
      font-size: 13px;
      padding: 8px 10px;
      border-radius: var(--radius-md);
    }

    .wikiSideLink:hover {
      background: rgba(0, 0, 0, 0.04);
      color: var(--text);
    }

    .wikiSideLink.isActive {
      background: rgba(0, 0, 0, 0.06);
      color: var(--text);
      font-weight: 700;
    }

    .wikiCard {
      transition: transform 180ms ease, box-shadow 180ms ease, border-color 180ms ease;
      will-change: transform;
    }

    .wikiCard:hover {
      transform: translateY(-10px);
    }

    .wikiCardLogoPlaceholder {
      width: 64px;
      height: 64px;
      border-radius: 12px;
      border: 1px dashed var(--border);
      background: rgba(0, 0, 0, 0.02);
      margin: 0 auto 8px;
    }

    .wikiCardDetails {
      overflow: hidden;
      max-height: 0;
      opacity: 0;
      transform: translateY(-4px);
      transition: max-height 260ms ease, opacity 220ms ease, transform 220ms ease;
      margin-top: 0;
    }

    .wikiCard.isOpen .wikiCardDetails {
      max-height: 1800px;
      opacity: 1;
      transform: translateY(0);
      margin-top: 18px;
    }

    .wikiDetailsHeader {
      display: grid;
      gap: 4px;
      margin-bottom: 10px;
    }

    .wikiDetailsTitle {
      font-weight: 800;
      font-size: 16px;
    }

    .wikiDetailsSubtitle {
      color: var(--muted);
      font-size: 13px;
    }

    .wikiDetailsText {
      color: var(--text);
      font-size: 14px;
      line-height: 1.5;
      margin-bottom: 12px;
    }

    .wikiDetailsIds {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 14px;
    }

    .wikiDetailsId {
      font-size: 12px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(0, 0, 0, 0.02);
    }

    .wikiDetailsGallery {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-bottom: 14px;
    }

    .wikiGalleryItem {
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: rgba(0, 0, 0, 0.02);
      padding: 10px;
      display: grid;
      grid-template-columns: 56px minmax(0, 1fr);
      gap: 10px;
      align-items: center;
    }

    .wikiGalleryImg {
      width: 56px;
      height: 56px;
      image-rendering: pixelated;
    }

    .wikiGalleryMeta {
      min-width: 0;
    }

    .wikiGalleryTitle {
      font-weight: 800;
      font-size: 14px;
      line-height: 1.2;
    }

    .wikiGalleryNs {
      margin-top: 2px;
      color: var(--muted);
      font-size: 12px;
      word-break: break-word;
    }

    .wikiMiniGrid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 12px;
      margin-top: 10px;
    }

    .wikiMiniCard {
      border: 1px solid var(--border);
      border-radius: var(--radius-md);
      background: rgba(0, 0, 0, 0.02);
      padding: 10px;
      display: grid;
      grid-template-columns: 44px minmax(0, 1fr);
      gap: 10px;
      align-items: center;
    }

    .wikiMiniIcon {
      width: 44px;
      height: 44px;
      image-rendering: pixelated;
    }

    .wikiMiniTitle {
      font-weight: 800;
      font-size: 13px;
      line-height: 1.2;
    }

    .wikiMiniNs {
      color: var(--muted);
      font-size: 12px;
      word-break: break-word;
      margin-top: 2px;
    }

    .wikiMiniSub {
      color: var(--text);
      font-size: 12px;
      margin-top: 2px;
      line-height: 1.35;
    }

    @media (max-width: 980px) {
      .wikiCard.isExpanded {
        grid-column: auto;
      }
    }
  </style>
</SiteLayout>