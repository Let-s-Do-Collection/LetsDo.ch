---
import SiteLayout from "../../layouts/SiteLayout.astro";
import NavBar from "../NavBar.astro";
import Footer from "../Footer.astro";
import Impressions from "./Impressions.astro";
import WikiSidebar from "./WikiSidebar.astro";
import MusicPlayer from "./MusicPlayer.astro";
import "../../styles/mods.css";
import "../../styles/wiki.css";
import "../../styles/wikisidebar.css";
import "../../styles/impressions.css";
import "../../styles/musicplayer.css";

const withBase = (path) => {
  if (!path) return "";
  if (path.startsWith("http://") || path.startsWith("https://")) return path;

  const base = import.meta.env.BASE_URL || "/";
  const cleanBase = base.endsWith("/") ? base.slice(0, -1) : base;
  const cleanPath = path.startsWith("/") ? path : `/${path}`;

  return `${cleanBase}${cleanPath}`;
};

const escapeHtml = (value) =>
  String(value ?? "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/"/g, "&quot;")
    .replace(/'/g, "&#039;");

const escapeHtmlWithBreaks = (value) => escapeHtml(value).replace(/\r\n|\r|\n/g, "<br />");

const normalizeId = (value) =>
  String(value ?? "")
    .trim()
    .toLowerCase()
    .replace(/\s+/g, "_")
    .replace(/[^\w\-]/g, "");

const linkifyText = (text) => {
  if (!text) return "";

  const parts = String(text).split(/(\[\[.*?\]\])/g);
  let out = "";

  for (let index = 0; index < parts.length; index += 1) {
    const part = parts[index];
    const match = part.match(/^\[\[(.+?)(?:\|(.+?))?\]\]$/);

    if (!match) {
      out += escapeHtmlWithBreaks(part);
      continue;
    }

    const label = match[1] ?? "";
    const rawTarget = match[2] ?? match[1] ?? "";
    const targetId = normalizeId(rawTarget);

    if (!targetId) {
      out += escapeHtml(label);
      continue;
    }

    out += `<a class="wikiInlineLink" href="#${escapeHtml(targetId)}">${escapeHtml(label)}</a>`;
  }

  return out;
};

const { config, currentSlug, wikiIndex } = Astro.props;

const title = config?.title ?? "Wiki";
const logo = config?.logo ?? "";
const aboutTitle = config?.aboutTitle ?? "Welcome";
const aboutSubtitle = config?.aboutSubtitle ?? "";
const aboutText = config?.aboutText ?? "";
const sections = Array.isArray(config?.sections) ? config.sections : [];
const wikis = Array.isArray(wikiIndex) ? wikiIndex : [];

const activeSlug = typeof currentSlug === "string" ? currentSlug : "";
const activeWiki = wikis.find((w) => w.slug === activeSlug) ?? null;
const activeWikiTitle = activeWiki?.title ?? title;

const searchPlaceholder = "Search items, blocks, features...";

const impressionsTitle = config?.impressionsTitle ?? "Impressions";
const impressionsSubtitle = config?.impressionsSubtitle ?? "Thats how it looks ingame";
const impressions = Array.isArray(config?.impressions) ? config.impressions : [];

const entrySearch = (entry) =>
  `${entry.title ?? ""} ${entry.subtitle ?? ""} ${entry.namespace_id ?? ""} ${entry.search ?? ""}`.toLowerCase();

const entryHasDetails = (entry) =>
  Boolean(entry.details) ||
  Boolean(entry.detailsTitle) ||
  Boolean(entry.detailsText) ||
  (Array.isArray(entry.detailsBullets) && entry.detailsBullets.length) ||
  (Array.isArray(entry.detailsIds) && entry.detailsIds.length) ||
  (Array.isArray(entry.detailsGallery) && entry.detailsGallery.length) ||
  (Array.isArray(entry.items) && entry.items.length) ||
  (Array.isArray(entry.tracks) && entry.tracks.length);

const titleCaseFromId = (id) =>
  String(id ?? "")
    .split("_")
    .filter(Boolean)
    .map((p) => p.slice(0, 1).toUpperCase() + p.slice(1))
    .join(" ");

const wikiHref = (slug) => withBase(`/wiki/${slug}/`);
---

<SiteLayout title={title}>
  <NavBar />

  <main class="page wikiShell">
    <WikiSidebar
      activeWikiTitle={activeWikiTitle}
      wikis={wikis}
      activeSlug={activeSlug}
      wikiHref={wikiHref}
      searchPlaceholder={searchPlaceholder}
      sections={sections}
      impressions={impressions}
      recipesCta={config?.recipesCta}
    />

    <div class="wikiContent" data-wiki-content>
      <div class="wikiMain">
        <section class="section sectionCentered">
          <div class="aboutHero modsHero wikiHero">
            {logo ? <img class="wikiHeroLogo" src={withBase(logo)} alt={title} loading="eager" /> : null}
          </div>
        </section>

        <section class="section sectionCentered sectionTight">
          <div class="sectionTitle">
            <span>{aboutTitle}</span>
          </div>

          {aboutSubtitle ? <p class="sectionSubtitle" set:html={escapeHtmlWithBreaks(aboutSubtitle)} /> : null}

          {aboutText ? <div class="aboutText" set:html={escapeHtmlWithBreaks(aboutText)} /> : null}
        </section>

        {sections.map((section) => {
          const sectionId = normalizeId(section.id);

          return (
            <section class="section sectionCentered sectionTight wikiSection" id={sectionId} data-section={sectionId}>
              <div class="wikiSectionHeader">
                <div class="sectionTitle">
                  <span>{section.title}</span>
                </div>

                {section.subtitle ? <p class="sectionSubtitle" set:html={escapeHtmlWithBreaks(section.subtitle)} /> : null}
              </div>

              <div class="gridWrapper">
                <div class="grid wikiGrid">
                  {(section.entries ?? []).map((entry) => {
                    const hasDetails = entryHasDetails(entry);
                    const iconSrc = entry.icon ? withBase(entry.icon) : "";
                    const detailsOpenTitle = entry.detailsTitle ?? "Details";
                    const tracks = Array.isArray(entry.tracks) ? entry.tracks : [];
                    const entryId = normalizeId(entry.id);

                    return (
                      <article
                        class="card wikiCard"
                        id={entryId}
                        data-section={sectionId}
                        data-search={entrySearch(entry)}
                        data-has-details={hasDetails ? "true" : "false"}
                        data-card-link="true"
                        tabindex="0"
                        role="link"
                        aria-label={entry.title ?? "Open"}
                      >
                        <div class="cardContent wikiCardContent">
                          {iconSrc ? (
                            <img class="cardLogo wikiCardLogo" src={iconSrc} alt={entry.title} loading="lazy" />
                          ) : (
                            <div class="wikiCardLogoPlaceholder" aria-hidden="true" />
                          )}

                          <h3>{entry.title}</h3>

                          {entry.namespace_id ? <div class="wikiCardNs">{entry.namespace_id}</div> : null}

                          {entry.subtitle ? <p set:html={linkifyText(entry.subtitle)} /> : null}
                        </div>

                        {hasDetails ? (
                          <div class="wikiCardDetails" aria-hidden="true">
                            <div class="wikiDetailsHeader">
                              <div class="wikiDetailsTitle">{detailsOpenTitle}</div>
                              {entry.detailsSubtitle ? <div class="wikiDetailsSubtitle" set:html={escapeHtmlWithBreaks(entry.detailsSubtitle)} /> : null}
                            </div>

                            {entry.detailsText ? <div class="wikiDetailsText" set:html={linkifyText(entry.detailsText)} /> : null}

                            {tracks.length ? <MusicPlayer tracks={tracks} /> : null}

                            {Array.isArray(entry.detailsIds) && entry.detailsIds.length ? (
                              <div class="wikiDetailsIds">
                                {entry.detailsIds.map((id) => (
                                  <div class="wikiDetailsId">{id}</div>
                                ))}
                              </div>
                            ) : null}

                            {Array.isArray(entry.detailsGallery) && entry.detailsGallery.length ? (
                              <div class="wikiCardDetailsGallery">
                                {entry.detailsGallery.map((g) => (
                                  <div class="wikiGalleryItem">
                                    <img class="wikiGalleryImg" src={g.icon ? withBase(g.icon) : ""} alt={g.title ?? ""} loading="lazy" />
                                    <div class="wikiGalleryMeta">
                                      <div class="wikiGalleryTitle">{g.title ?? ""}</div>
                                      {g.namespace_id ? <div class="wikiGalleryNs">{g.namespace_id}</div> : null}
                                    </div>
                                  </div>
                                ))}
                              </div>
                            ) : null}

                            {Array.isArray(entry.detailsBullets) && entry.detailsBullets.length ? (
                              <ul class="wikiDetailsList">
                                {entry.detailsBullets.map((line) => (
                                  <li>{line}</li>
                                ))}
                              </ul>
                            ) : null}

                            {Array.isArray(entry.items) && entry.items.length ? (
                              <div class="wikiMiniGrid">
                                {entry.items.map((it) => {
                                  const itemId = normalizeId(it.id);

                                  return (
                                    <article class="wikiMiniCard" id={itemId} data-search={entrySearch(it)}>
                                      <img class="wikiMiniIcon" src={it.icon ? withBase(it.icon) : ""} alt={it.title ?? ""} loading="lazy" />
                                      <div class="wikiMiniBody">
                                        <div class="wikiMiniTitle">{it.title ?? titleCaseFromId(it.id)}</div>
                                        {it.namespace_id ? <div class="wikiMiniNs">{it.namespace_id}</div> : null}
                                        {it.subtitle ? <div class="wikiMiniSub" set:html={escapeHtmlWithBreaks(it.subtitle)} /> : null}
                                      </div>
                                    </article>
                                  );
                                })}
                              </div>
                            ) : null}
                          </div>
                        ) : null}

                        <div class="cardAction">
                          {hasDetails ? (
                            <button class="btn btnSecondary wikiToggle" type="button" aria-expanded="false">
                              More info
                            </button>
                          ) : null}

                          {entry.wikiHref ? (
                            <a class="btn btnPrimary" href={entry.wikiHref}>
                              View
                            </a>
                          ) : null}
                        </div>
                      </article>
                    );
                  })}
                </div>
              </div>

              <div class="modsEmpty" data-empty-for={sectionId} style="display:none;">
                No results in {section.title}.
              </div>
            </section>
          );
        })}

        {config?.recipesCta?.enabled ? (
          <section class="section sectionCentered sectionTight wikiSection wikiRecipesCta" id="recipes" data-section="recipes">
            <div class="sectionTitle">
              <span>{config.recipesCta.title ?? "Recipes"}</span>
            </div>

            {config.recipesCta.text ? <p class="sectionSubtitle" set:html={escapeHtmlWithBreaks(config.recipesCta.text)} /> : null}

            <div class="wikiRecipesCtaAction">
              <a class="btn btnPrimary" href={withBase(config.recipesCta.href ?? "/recipes/")}>
                {config.recipesCta.buttonLabel ?? "Open Recipe Overview"}
              </a>
            </div>
          </section>
        ) : null}

        <Impressions id="impressions" title={impressionsTitle} subtitle={impressionsSubtitle} images={impressions} />
      </div>
    </div>
  </main>

  <Footer />

  <script is:inline>
    const setNavHeightVar = () => {
      const header = document.querySelector("header");
      const element = header || document.querySelector("nav");
      const height = element ? Math.ceil(element.getBoundingClientRect().height) : 120;
      document.documentElement.style.setProperty("--navHeight", `${height}px`);
    };

    setNavHeightVar();
    window.addEventListener("resize", setNavHeightVar, { passive: true });

    const input = document.getElementById("wikiSearchInput");
    const cards = Array.from(document.querySelectorAll(".wikiCard[data-search]"));
    const sections = Array.from(document.querySelectorAll(".wikiSection"));
    const sectionLinks = Array.from(document.querySelectorAll("[data-section-link]"));

    const dropdown = document.getElementById("wikiDropdown");
    const dropdownButton = document.getElementById("wikiDropdownButton");
    const dropdownMenu = document.getElementById("wikiDropdownMenu");

    const setDropdownOpen = (open) => {
      if (!dropdown || !dropdownButton || !dropdownMenu) return;
      dropdown.dataset.open = open ? "true" : "false";
      dropdownButton.setAttribute("aria-expanded", open ? "true" : "false");
      dropdownMenu.hidden = !open;
    };

    if (dropdownButton && dropdownMenu) {
      dropdownButton.addEventListener("click", (event) => {
        event.preventDefault();
        event.stopPropagation();
        const openNow = dropdown.dataset.open === "true";
        setDropdownOpen(!openNow);
      });

      dropdownMenu.addEventListener("click", (event) => {
        const link = event.target.closest("a");
        if (!link) return;
        setDropdownOpen(false);
      });

      document.addEventListener("click", (event) => {
        if (!dropdown) return;
        if (dropdown.contains(event.target)) return;
        setDropdownOpen(false);
      });

      document.addEventListener("keydown", (event) => {
        if (event.key === "Escape") setDropdownOpen(false);
      });
    }

    const getHashId = () => {
      const raw = (window.location.hash || "").slice(1);
      return raw ? raw.trim() : "";
    };

    const setHash = (hashId) => {
      const cleanId = String(hashId || "").trim();
      if (!cleanId) {
        history.replaceState(null, "", window.location.pathname + window.location.search);
        return;
      }
      history.replaceState(null, "", `#${cleanId}`);
    };

    const isInteractiveTarget = (target) => {
      if (!target) return false;
      return Boolean(target.closest("a, button, input, textarea, select, label, summary, details"));
    };

    const setOpen = (card, open) => {
      const details = card.querySelector(".wikiCardDetails");
      const toggle = card.querySelector(".wikiToggle");
      if (!details || !toggle) return;

      card.classList.toggle("isOpen", open);
      card.classList.toggle("isExpanded", open);

      details.setAttribute("aria-hidden", open ? "false" : "true");
      toggle.setAttribute("aria-expanded", open ? "true" : "false");
      toggle.textContent = open ? "Less info" : "More info";

      if (open) {
        for (const other of cards) {
          if (other !== card) {
            other.classList.remove("isOpen", "isExpanded");
            const otherDetails = other.querySelector(".wikiCardDetails");
            const otherToggle = other.querySelector(".wikiToggle");
            if (otherDetails) otherDetails.setAttribute("aria-hidden", "true");
            if (otherToggle) {
              otherToggle.setAttribute("aria-expanded", "false");
              otherToggle.textContent = "More info";
            }
          }
        }
      }
    };

    const openFromHash = () => {
      const hashId = getHashId();
      if (!hashId) return;

      const target = document.getElementById(hashId);
      if (!target) return;

      const card = target.classList.contains("wikiCard") ? target : target.closest(".wikiCard");
      if (card) {
        const hasDetails = card.getAttribute("data-has-details") === "true";
        if (hasDetails) setOpen(card, true);

        requestAnimationFrame(() => {
          card.scrollIntoView({ behavior: "smooth", block: "center" });
        });
        return;
      }

      requestAnimationFrame(() => {
        target.scrollIntoView({ behavior: "smooth", block: "start" });
      });
    };

    const activateCardLink = (card, openDetails) => {
      if (!card || !card.id) return;

      setHash(card.id);

      if (openDetails) {
        const hasDetails = card.getAttribute("data-has-details") === "true";
        if (hasDetails) setOpen(card, true);
      }

      requestAnimationFrame(() => {
        card.scrollIntoView({ behavior: "smooth", block: "center" });
      });
    };

    document.addEventListener("click", (event) => {
      const toggle = event.target.closest(".wikiToggle");
      if (toggle) {
        const card = toggle.closest(".wikiCard");
        if (!card) return;

        const open = !card.classList.contains("isOpen");
        setOpen(card, open);

        if (open && card.id) {
          setHash(card.id);
        } else if (!open && card.id && getHashId() === card.id) {
          setHash("");
        }

        if (open) {
          requestAnimationFrame(() => {
            card.scrollIntoView({ behavior: "smooth", block: "center" });
          });
        }

        return;
      }

      if (isInteractiveTarget(event.target)) return;

      const card = event.target.closest('.wikiCard[data-card-link="true"]');
      if (!card) return;

      activateCardLink(card, false);
    });

    document.addEventListener("keydown", (event) => {
      if (event.key !== "Enter" && event.key !== " ") return;
      if (isInteractiveTarget(event.target)) return;

      const card = event.target.closest('.wikiCard[data-card-link="true"]');
      if (!card) return;

      event.preventDefault();
      activateCardLink(card, false);
    });

    const updateActiveSection = () => {
      const fromTop = window.scrollY + 140;
      let active = null;

      for (const section of sections) {
        if (section.offsetTop <= fromTop) active = section;
      }

      const impressionsEl = document.getElementById("impressions");
      if (impressionsEl && impressionsEl.offsetTop <= fromTop) active = impressionsEl;

      const activeId = active ? active.id : null;
      for (const link of sectionLinks) {
        link.classList.toggle("isActive", link.getAttribute("data-section-link") === activeId);
      }
    };

    const update = () => {
      const q = (input.value || "").trim().toLowerCase();
      const visiblePerSection = new Map();

      for (const card of cards) {
        const hay = card.getAttribute("data-search") || "";
        const show = q.length === 0 || hay.includes(q);
        card.style.display = show ? "" : "none";

        if (!show) setOpen(card, false);

        const sectionId = card.getAttribute("data-section");
        if (show) visiblePerSection.set(sectionId, (visiblePerSection.get(sectionId) || 0) + 1);
      }

      for (const section of sections) {
        const sectionId = section.id;
        const count = visiblePerSection.get(sectionId) || 0;
        const emptyEl = section.querySelector(`[data-empty-for="${sectionId}"]`);
        if (emptyEl) emptyEl.style.display = count === 0 ? "" : "none";
      }
    };

    if (input) input.addEventListener("input", update);
    window.addEventListener("scroll", updateActiveSection, { passive: true });
    window.addEventListener("hashchange", openFromHash, { passive: true });

    update();
    updateActiveSection();
    openFromHash();
  </script>
</SiteLayout>